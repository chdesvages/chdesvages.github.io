% !TeX program = xelatex
% chktex-file 3
% chktex-file 8
% chktex-file 12
% chktex-file 24
% chktex-file 42

\documentclass[a4paper,nobib,nols]{tufte-book}

%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
% Document Macros                                                   %
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%

\renewcommand{\smallcapsspacing}[1]{{\addfontfeature{LetterSpace=5.0}#1}}
\renewcommand{\smallcaps}[1]{\smallcapsspacing{\scshape\MakeTextLowercase{#1}}}
\renewcommand{\allcapsspacing}[1]{{\addfontfeature{LetterSpace=10.0}#1}}
\renewcommand{\textsc}[1]{\smallcapsspacing{\textsmallcaps{#1}}}
\renewcommand{\epsilon}{\varepsilon}

% chapter format
\titleformat{\chapter}%
  {\LARGE\sffamily\color{sbase03}}% format applied to label+text
  {\thechapter}% label
  {1cm}% horizontal separation between label and title body
  {\MakeUppercase}% before the title body
  []% after the title body

\titleformat{\section}%
  {\normalfont\Large\sffamily\color{sbase03}}% format applied to label+text
  {\thesection}% label
  {0.5cm}% horizontal separation between label and title body
  {}% before the title body
  []% after the title body

\usepackage[minionmath]{boilerart}
\usepackage{xifthen}

%-------------------------------------------------------------------%
%  Title data                                                       %
%-------------------------------------------------------------------%

\title{La Longue Marche}

\author{Clark Barwick}

\publisher{A Research Diary}

%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%

\newenvironment{loggentry}[2]% date, heading
{\noindent\textbf{#2}\marginnote{#1}\par}{\vspace{0.5cm}}

\def\?#1{}

\pgfmathtruncatemacro{\StartYear}{2021}
\pgfmathtruncatemacro{\EndYear}{2021}

\newcommand{\writetitle}{0}
\newcommand{\mytitle}[1]
{   \ifthenelse{\writetitle=1}{#1}{}
}

\newread\mysource

\begin{document}

\maketitle

%\bookmark[page=1,level=1]{Contents}
\setcounter{tocdepth}{2}
\tableofcontents

\bigskip

\foreach \Year in {\StartYear,...,\EndYear}{
	\chapter*{\Year}
	\addcontentsline{toc}{chapter}{\Year}
	\foreach \Month in {January,February,March,April,May,June,July,August,September,October,November,December}{
		\IfFileExists{
			\Year/\Month/flag}{
			\section*{\Month}
			\addcontentsline{toc}{section}{\Month}
		}
		{   % file does not exist, so nothing to do
		}
		\foreach \Day in {1,...,31}{
			\IfFileExists{\Year/\Month/\Day}{
				\openin\mysource=\Year/\Month/\Day.tex
				\read\mysource to \firstline
				\closein\mysource
				\xdef\writetitle{1}
				\begin{loggentry}{\Year\ \Month\ \Day}{\firstline} 
					\xdef\writetitle{0}
					\input{\Year/\Month/\Day}
				\end{loggentry} 
			}
			{   % file does not exist, so nothing to do
			}

		} 
	}
}

\backmatter

%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
%  References                                                       %
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%
%-------------------------------------------------------------------%

% Separates bibliography into two parts: the specially labeled references followed by the numbered references. The specially labeled references appear with just the label; numbered references appear as "n."
\DeclareFieldFormat{labelnumberwidth}{#1}
\printbibliography[keyword=alph]
\addcontentsline{toc}{part}{References} % Adds References to table of contents
\DeclareFieldFormat{labelnumberwidth}{{#1\adddot\midsentence}}
\printbibliography[heading=none, notkeyword=alph]

\end{document}
